{"source":"__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nMeteor.publishComposite('adminCollectionDoc', function(collection, id) {\n  var ref, ref1;\n  check(collection, String);\n  check(id, Match.OneOf(String, Mongo.ObjectID));\n  if (Roles.userIsInRole(this.userId, ['admin'])) {\n    return {\n      find: function() {\n        return adminCollectionObject(collection).find(id);\n      },\n      children: (typeof AdminConfig !== \"undefined\" && AdminConfig !== null ? (ref = AdminConfig.collections) != null ? (ref1 = ref[collection]) != null ? ref1.children : void 0 : void 0 : void 0) || []\n    };\n  } else {\n    return this.ready();\n  }\n});\n\nMeteor.publish('adminUsers', function() {\n  if (Roles.userIsInRole(this.userId, ['admin'])) {\n    return Meteor.users.find();\n  } else {\n    return this.ready();\n  }\n});\n\nMeteor.publish('adminUser', function() {\n  return Meteor.users.find(this.userId);\n});\n\nMeteor.publish('adminCollectionsCount', function() {\n  var handles, self;\n  handles = [];\n  self = this;\n  _.each(AdminTables, function(table, name) {\n    var count, id, ready, selector;\n    id = new Mongo.ObjectID;\n    count = 0;\n    table = AdminTables[name];\n    ready = false;\n    selector = table.selector ? table.selector(self.userId) : {};\n    handles.push(table.collection.find().observeChanges({\n      added: function() {\n        count += 1;\n        return ready && self.changed('adminCollectionsCount', id, {\n          count: count\n        });\n      },\n      removed: function() {\n        count -= 1;\n        return ready && self.changed('adminCollectionsCount', id, {\n          count: count\n        });\n      }\n    }));\n    ready = true;\n    return self.added('adminCollectionsCount', id, {\n      collection: name,\n      count: count\n    });\n  });\n  self.onStop(function() {\n    return _.each(handles, function(handle) {\n      return handle.stop();\n    });\n  });\n  return self.ready();\n});\n\nMeteor.publish(null, function() {\n  return Meteor.roles.find({});\n});\n","sourceMap":{"version":3,"file":"/lib/server/publish.coffee.js","sourceRoot":"","sources":["/packages/wangziguan_admin/lib/server/publish.coffee"],"names":[],"mappings":"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","sourcesContent":["Meteor.publishComposite 'adminCollectionDoc', (collection, id) ->\n\tcheck collection, String\n\tcheck id, Match.OneOf(String, Mongo.ObjectID)\n\tif Roles.userIsInRole this.userId, ['admin']\n\t\tfind: ->\n\t\t\tadminCollectionObject(collection).find(id)\n\t\tchildren: AdminConfig?.collections?[collection]?.children or []\n\telse\n\t\t@ready()\n\nMeteor.publish 'adminUsers', ->\n\tif Roles.userIsInRole @userId, ['admin']\n\t\tMeteor.users.find()\n\telse\n\t\t@ready()\n\nMeteor.publish 'adminUser', ->\n\tMeteor.users.find @userId\n\nMeteor.publish 'adminCollectionsCount', ->\n\thandles = []\n\tself = @\n\n\t_.each AdminTables, (table, name) ->\n\t\tid = new Mongo.ObjectID\n\t\tcount = 0\n\t\ttable = AdminTables[name]\n\t\tready = false\n\t\tselector = if table.selector then table.selector(self.userId) else {}\n\t\thandles.push table.collection.find().observeChanges\n\t\t\tadded: ->\n\t\t\t\tcount += 1\n\t\t\t\tready and self.changed 'adminCollectionsCount', id, {count: count}\n\t\t\tremoved: ->\n\t\t\t\tcount -= 1\n\t\t\t\tready and self.changed 'adminCollectionsCount', id, {count: count}\n\t\tready = true\n\n\t\tself.added 'adminCollectionsCount', id, {collection: name, count: count}\n\n\tself.onStop ->\n\t\t_.each handles, (handle) -> handle.stop()\n\tself.ready()\n\nMeteor.publish null, ->\n\tMeteor.roles.find({})\n"]}}