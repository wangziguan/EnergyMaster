[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar MeteorX = Package['meteorhacks:meteorx'].MeteorX;\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                             //\n// packages/meteorhacks_unblock/packages/meteorhacks_unblock.js                                //\n//                                                                                             //\n/////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                               //\n(function () {\n\n///////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                       //\n// packages/meteorhacks:unblock/lib/unblock.js                                           //\n//                                                                                       //\n///////////////////////////////////////////////////////////////////////////////////////////\n                                                                                         //\nvar cachedUnblock;                                                                       // 1\n                                                                                         // 2\nvar originalSub = MeteorX.Session.prototype.protocol_handlers.sub;                       // 3\nMeteorX.Session.prototype.protocol_handlers.sub = function(msg, unblock) {               // 4\n  var self = this;                                                                       // 5\n  // cacheUnblock temporarly, so we can capture it later                                 // 6\n  // we will use unblock in current eventLoop, so this is safe                           // 7\n  cachedUnblock = unblock;                                                               // 8\n  originalSub.call(self, msg, unblock);                                                  // 9\n  // cleaning cached unblock                                                             // 10\n  cachedUnblock = null;                                                                  // 11\n};                                                                                       // 12\n                                                                                         // 13\n// We simply replace current implementation with a simple modification                   // 14\n// to add add the unblock                                                                // 15\nMeteorX.Session.prototype._startSubscription = function (handler, subId, params, name) { // 16\n  var self = this;                                                                       // 17\n  var sub = new MeteorX.Subscription(self, handler, subId, params, name);                // 18\n                                                                                         // 19\n  var unblockHander = cachedUnblock;                                                     // 20\n  // _startSubscription may call from a lot places                                       // 21\n  // so cachedUnblock might be null in somecases                                         // 22\n  if(!unblockHander) {                                                                   // 23\n    unblockHander = function() {}                                                        // 24\n  }                                                                                      // 25\n  // assign the cachedUnblock                                                            // 26\n  sub.unblock = unblockHander ;                                                          // 27\n                                                                                         // 28\n  if(subId) {                                                                            // 29\n    self._namedSubs[subId] = sub;                                                        // 30\n  } else {                                                                               // 31\n    self._universalSubs.push(sub);                                                       // 32\n  }                                                                                      // 33\n                                                                                         // 34\n  sub._runHandler();                                                                     // 35\n};                                                                                       // 36\n                                                                                         // 37\n// sometimes _runHandler will be called directly and                                     // 38\n// we won't have the session context and cachedUnblock                                   // 39\n// so, those situations, set a dummy function for unblock                                // 40\n// this happens often when logging in and out                                            // 41\nvar originalRunHandler = MeteorX.Subscription.prototype._runHandler;                     // 42\nMeteorX.Subscription.prototype._runHandler = function() {                                // 43\n  if(!this.unblock) {                                                                    // 44\n    this.unblock = function() {};                                                        // 45\n  }                                                                                      // 46\n  originalRunHandler.call(this);                                                         // 47\n}                                                                                        // 48\n///////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n/////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nPackage._define(\"meteorhacks:unblock\");\n\n})();\n","servePath":"/packages/meteorhacks_unblock.js"}]